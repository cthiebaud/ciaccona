<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJBNRY1Z9M"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-DJBNRY1Z9M');    
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <meta name="keywords" content="Bach, JSBach, J.S. Bach, BWV1004, BWV 1004, Partita, 2nd Partita, Ciaconna, Chaconne">
    <meta name="author" content="Christophe Thiebaud">

    <!-- HTML Meta Tags -->
    <title>Ciaccona</title>
    <meta name="description" content="35 performances of Johann Sebastian Bach's Ciaccona from Partita in D minor for solo violin BWV1004">

    <!-- https://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Facebook Meta Tags -->
    <meta property="fb:app_id" content="176898451849553">
    <meta property="og:locale" content="en_GB" />
    <meta property="og:site_name" content="ciaccona.cthiebaud.com" />
    <meta property="og:url" content="https://ciaccona.cthiebaud.com/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Ciaccona">
    <meta property="og:description" content="35 performances of Johann Sebastian Bach's Ciaccona from Partita in D minor for solo violin BWV1004">
    <meta property="og:image" content="https://ciaccona.cthiebaud.com/logo5.jpg" />
    <meta property="og:image:url" content="https://ciaccona.cthiebaud.com/logo5.jpg" />
    <meta property="og:image:type" content="image/jpeg" />
    <meta property="og:image:width" content="2400" />
    <meta property="og:image:height" content="1256" />

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:creator" content="@cthiebaud">
    <meta property="twitter:domain" content="ciaccona.cthiebaud.com">
    <meta property="twitter:url" content="https://ciaccona.cthiebaud.com/">
    <meta name="twitter:title" content="Ciaccona">
    <meta name="twitter:description" content="35 performances of Johann Sebastian Bach's Ciaccona from Partita in D minor for solo violin BWV1004">
    <meta name="twitter:image" content="https://ciaccona.cthiebaud.com/logo5.jpg">

    <!-- Apple iOS "Add to Home Screen" HTML meta tags https://gist.github.com/miguelmota/b874f287a77d96034b26a68ab56280f5 -->
    <!-- meta name="viewport" content="width=device-width, initial-scale=1" / -->
    <meta name="application-name" content="Ciaccona" />
    <meta name="apple-mobile-web-app-title" content="Ciaccona" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <!-- link rel="apple-touch-icon" href="/icon.png" / -->

    <!-- bootstrap -->
    <link rel="stylesheet" href="/lib/bootstrap-5.2.3.min.css">

    <!-- early scripts -->
    <script>
        const params2 = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop)
        })
        let coerceArtist = params2.a ?? undefined
        let coerceVariation = params2.v ?? undefined
        let shuffle = params2.shuffle ?? undefined
        if (typeof shuffle !== 'undefined' && (shuffle === 'false' || shuffle === '0' || !shuffle)) {
            shuffle = false
        } else {
            shuffle = true
        }

        // transform packery event into promise
        const readyToPack = new Promise((resolve) => {
            window.addEventListener('readyToPack', (event) => {
                console.log("... heard readyToPack event");
                resolve(event)
            }, { once: true })
        })        
    </script>
    <script type="module">
        import { theTrickToViewportUnitsOnMobile } from '/js/utils.js?v=0.13.1'

        // list item width
        function calcItemWidth() {
            const listE = document.querySelector('.artists #list')
            console.log('.ARTISTS #LIST', listE)
            if (listE) {
                const containerWidth = listE.getBoundingClientRect().width
                const gutter_sizer = 0.0125;
                const gutter_size = containerWidth * gutter_sizer
                const listItemsPerRow = 1 + Math.floor(containerWidth / 400)
                const listItemsWidth = (containerWidth - (listItemsPerRow - 1) * gutter_size) / listItemsPerRow
                const listItemsDoubleWidth = 2 * listItemsWidth + gutter_size - .2
                const listItemPercentageWidth = 100 * listItemsWidth / containerWidth
                const listItemDoublPercentageWidth = 100 * listItemsDoubleWidth / containerWidth
                const listItemsHeight = listItemsWidth / 1.91;
                const listItemsDoubleHeight = listItemsHeight * 2 + gutter_size - .2

                document.documentElement.style.setProperty('--gs', `${gutter_sizer * 100}%`)
                document.documentElement.style.setProperty('--lipr', `${listItemsPerRow}`)
                document.documentElement.style.setProperty('--lipc', `${Math.ceil(36 / listItemsPerRow)}`)
                document.documentElement.style.setProperty('--liw', `${listItemPercentageWidth}%`)
                document.documentElement.style.setProperty('--lih', `${listItemsHeight}px`)
                document.documentElement.style.setProperty('--2liw', `${listItemDoublPercentageWidth}%`)
                document.documentElement.style.setProperty('--2lih', `${listItemsDoubleHeight}px`)
            }
            console.log('shout readyToPack event...')
            window.dispatchEvent(new Event('readyToPack'));
        }

        window.addEventListener("calcItemWidth", (event) => {
            console.log('...heard calcItemWidth event')
            calcItemWidth()
        });

        window.addEventListener("DOMContentLoaded", (event) => {
            calcItemWidth()
        }, { once: true });

        theTrickToViewportUnitsOnMobile(true, () => calcItemWidth())
    </script>

    <!-- google font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/packery@2.1.2/sandbox/css/basics.min.css">

    <link href="/global.css?v=0.13.1" rel="stylesheet">
    <link href="/index.css?v=0.13.1" rel="stylesheet">

</head>

<body class="artists no-vid d-flex flex-column"> <!-- #787160 -->
    <main id="listContainer" class="container-xxl flex-shrink-0">
        <div id="listContainerRow" class="row justify-content-end" style="margin:0"> <!--  -->
            <div id="listContainerCol" class="col">
                <div id="list" style="color:white; margin: .5rem 0;">
                    <div class="gutter-sizer"></div>
                </div>
            </div>
        </div>
    </main>

    <script async type="module">
        import packeryLayout from 'https://cdn.jsdelivr.net/npm/packery@2.1.2/+esm'
        import codec from "/js/structure.js?v=0.13.1"
        import { colorArray } from "/js/colors.js?v=0.13.1.1"
        import { loadArtists } from "/js/artists.js?v=0.13.1"
        import { shuffleArray, generateElement } from "/js/utils.js?v=0.13.1"
        import { jigsawGenerator } from '/js/jigsawShield.js?v=0.13.1'

        const bg = (a, v) => `url('https://musicollator.github.io/ciaccona-stationary/artists/${a}/${a}-${v}.webp')`

        const template = (data) => `
<div id="li-artist${data.v}" 
     class="list-artist hero"  
     data-index="${data.index}" 
     data-a="${data.a}" 
     data-v="${data.v}" 
     style="background-image: ${data.bg}; overflow:hidden;">
    <div class="d-flex flex-column justify-content-start${data.hideName}" style="height:100%;" >
        <div class="hero-intro flex-shrink-1; align-self-start;" 
            title="Pin / Unpin ${data.firstname} ${data.lastname}"
            style="padding-right: 0.5rem;">
            ${data.firstname}
        </div>
        <div class="hero-intro vert flex-grow-1;" 
            title="Pin / Unpin ${data.firstname} ${data.lastname}">
            ${data.lastname}
        </div>
    </div>
    <a class="puzzle flex-shrink-1" href="#" title="Pin / Unpin Variation NÂ°${data.v}">
        <svg xmlns="http://www.w3.org/2000/svg" 
            id="gb-puzzle${data.v}-svg" 
            style="overflow: visible; transform: scale(.667);"
            viewBox="${data.jigsaw.viewBox}">
            <path stroke="#${data.stroke ? data.stroke : 'C8B273'}" 
                stroke-width="3" 
                fill="#${data.fill ? data.fill : '57728ba0'}" 
                d="${data.jigsaw.path}" style=""></path>
        </svg>
    </a>
</div>`

        let data = []
        let arrayOfArtists = []
        const colors = colorArray;

        function generateData() {
            data = []
            let vi = 0
            arrayOfArtists.forEach(a => {
                if (a.fullnameNoSpaceLowercaseNoDiacritics === 'moi') {
                    return;
                }
                const j = jigsawGenerator.getJigsawItem(vi + 1)
                const transX = parseInt(j.viewBox.replaceAll(/^([\.\d\-]+).*$/g, "$1"))
                const transY = parseInt(j.viewBox.replaceAll(/^[\.\d\-]+\s+([\.\d\-]+).*$/g, "$1"))
                const artistLastnameNoBreakingSpaces = a.lastname.replaceAll(/\s/gi, '&nbsp;');
                const datum = {
                    index: vi,
                    a: coerceArtist || a.fullnameNoSpaceLowercaseNoDiacritics,
                    v: coerceVariation || vi % codec.variationsCount,
                    puzzleHRef: coerceVariation ? '/' : `?v=${vi % codec.variationsCount}`,
                    firstname: a.firstname,
                    lastname: artistLastnameNoBreakingSpaces,
                    bg: bg(coerceArtist || a.fullnameNoSpaceLowercaseNoDiacritics, coerceVariation || vi % codec.variationsCount),
                    jigsaw: j,
                    hideName: coerceArtist ? ' hide-name' : '',
                    fill: colors[coerceVariation || vi % codec.variationsCount].puzzleColor_T,
                    stroke: colors[coerceVariation || vi % codec.variationsCount].textColor_T,
                }
                data.push(datum)
                vi++
            })
            return data;
        }

        loadArtists().then((artists) => {

            const list = document.getElementById('list')

            list.querySelectorAll('.list-artist').forEach(E => E.remove())

            list.innerHTML += `
            <div id="li-ciaccona" 
                class="list-item d-flex align-items-center justify-content-center" 
                <div>
                    <a class="magnificent-card p-2" href="/ciaccona.html" aria-label="Ciaccona...">
                        &nbsp;
                        <div style="margin: auto; font-size: 28px;">Ciaccona</div>
                        &nbsp;
                        <svg id="arrow_in_right" class="align-self-center" style="width:32px; height:32px;" viewBox="0 0 20 20">
                            <path fill="#00000060" fill-rule="evenodd"
                                d="M7.392 5.06 5.938 6.408 8.366 9H0v2h8.366l-2.428 2.544 1.454 1.362 4.671-4.948L7.392 5.06ZM10 0v4h2V2h6v16h-6v-2h-2v4h10V0H10Z" />
                        </svg>
                        &nbsp;
                    </a>
                </div>
            </div>`

            arrayOfArtists = shuffle ? shuffleArray(artists.artists) : artists.artists
            data = generateData(arrayOfArtists)
            data.forEach(d => {
                list.innerHTML += `<div class="list-item">${template(d)}</div>`
            })

            const event = new Event("artistsLoaded");
            window.dispatchEvent(event);

            readyToPack.then((result) => {
                console.log("let's pack")
                const thePackery = new packeryLayout('#list', {
                    itemSelector: ".list-item",
                    percentPosition: false,
                    initLayout: false,
                    gutter: '.gutter-sizer',
                    resize: true
                })

                thePackery.on('layoutComplete', function () {
                    console.log("Packery layout complete");
                })

                thePackery.layout()

                setListener()

                function forceRedraw() {
                    document.querySelectorAll('.list-item:not(#li-ciaccona)').forEach(E => {
                        const i = E.children[0].dataset.index
                        const newChild = generateElement(template(data[i]))
                        E.replaceChild(newChild, E.children[0])
                    })
                    setListener()
                }

                function setListener() {
                    // https://codepen.io/desandro/pen/WxjJJW/
                    document.querySelectorAll('.list-artist').forEach(E => E.addEventListener('click', (event) => {
                        console.log('currentTarget', event.currentTarget, 'target', event.target)
                        if (event.currentTarget === event.target) {
                            event.stopPropagation()
                            event.preventDefault()
                            window.location = `/ciaccona.html?a=${event.target.dataset.a}&v=${event.target.dataset.v}`
                        }
                    }))
                    document.querySelectorAll('.list-artist .puzzle').forEach(E => E.addEventListener('click', (event) => {
                        event.stopPropagation()
                        event.preventDefault()
                        if (coerceVariation) {
                            coerceVariation = undefined
                        } else {
                            coerceVariation = event.currentTarget.parentNode.dataset.v
                        }
                        data = generateData(arrayOfArtists)
                        forceRedraw()
                    }))
                    document.querySelectorAll('.list-artist .hero-intro').forEach(E => E.addEventListener('click', (e) => {
                        event.stopPropagation()
                        event.preventDefault()
                        if (coerceArtist) {
                            coerceArtist = undefined
                        } else {
                            coerceArtist = event.currentTarget.parentNode.parentNode.dataset.a
                        }
                        data = generateData(arrayOfArtists)
                        forceRedraw()
                    }))
                }
            })

            /*
            function orderItems(reorder) {
                var itemElems = thePackery.getItemElements()
                let vi = 0
                itemElems.forEach(function (itemElem) {
                    // console.log(i, itemElem)
                    const v = reorder || typeof itemElem.dataset.v === 'undefined' ? vi : itemElem.dataset.v
                    if (itemElem.dataset.a) {
                        let bgFull
                        const a = itemElem.dataset.a
                        if (a === 'moi') {
                            // bgFull = { 'background-color': '#28282b' }
                            itemElem.style.backgroundColor = '#28282b'
                        } else {
                            // bgFull = { 'background-image': bg(itemElem.dataset.a, v) }
                            itemElem.style.backgroundImage = bg(itemElem.dataset.a, v)
                        }
                    }
                    vi++
                });
            }
            orderItems()
            $list.on('dragItemPositioned', function () {
                orderItems(true)
            });

            $list.on('fitComplete', function (item) {
                orderItems()
                $list.packery('shiftLayout');
            })
            $list.on('click', '.list-artist .puzzle', function (event) {
                event.stopPropagation()
                event.preventDefault()
                const target = event.currentTarget.parentNode;
                window.location = `/puzzle/?a=${target.dataset.a}&v=${target.dataset.v}`
            })
            function removeLarges() {
                const $wereLarges = $('.list-artist.large');
                $wereLarges.each((index, wasLarge) => {
                    wasLarge.classList.remove('large')
                    let item = $list.packery('getItem', wasLarge)
                    if (item && item.previousPosition) {
                        // fit back in previous position
                        console.log('about to fit')
                        $list.packery('fit', wasLarge, item.previousPosition.x, item.previousPosition.y);
                        // remove previous position
                        delete item.previousPosition;
                    }
                })
            }
            $('body').on('click', function (event) {
                event.stopPropagation()
                event.preventDefault()
                removeLarges()
            })
            $list.on('click', '.list-artist .grabber', function (event) {
                event.stopPropagation()
            })
            $list.on('click', '.list-artist', function (event) {
                event.stopPropagation()
                event.preventDefault()
                var target = event.currentTarget;
                var targetWasLarge = target.classList.contains('large');
                removeLarges()
                if (!targetWasLarge) {
                    target.classList.add('large');
                    var item = $list.packery('getItem', target)
                    // save previous position
                    item.previousPosition = {
                        x: item.position.x,
                        y: item.position.y
                    };
                    console.log('about to fit')
                    $list.packery('fit', target);
                }
            });
            */
        })

    </script>

</body>

</html>