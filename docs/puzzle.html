<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DJBNRY1Z9M"></script>
    <script type="module">
        import config from "/js/config.js?v=0.9.4"

        if (!config.incognito) {
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());

            gtag('config', 'G-DJBNRY1Z9M');
        }
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" -->
    <meta name="keywords" content="Bach, JSBach, J.S. Bach, BWV1004, BWV 1004, Partita, 2nd Partita, Ciaconna, Chaconne, Puzzle">
    <meta name="author" content="Christophe Thiebaud">

    <!-- HTML Meta Tags -->
    <title>Ciaccona - Puzzle</title>
    <meta name="description" content="Puzzle">

    <!-- https://realfavicongenerator.net/ -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <style>
        * {
            box-sizing: border-box;
        }

        /* force scroll bar */
        html {
            overflow-y: scroll;
        }

        body#body {
            font-family: sans-serif;
            /* background: #DDD; */
            background-color: #333;
            color: #555;
            text-align: center;
            padding-bottom: 50px;
        }

        a {
            color: #19F;
        }

        a:hover {
            color: #C25;
        }

        .grid {
            width: 1200px;
            min-width: 1200px;
            background-color: #333;
            /* margin: 50px auto; */
            min-height: 628px;
            z-index: 2;
        }

        .tile {
            float: left;
            width: 150px;
            height: 157px;
            /*   border: 1px solid; */
            background-color: #333;
            /* background-image: url('/artists/martinbaker/martinbaker-10.jpg'); */
            cursor: move;
        }

        .tile.w2 {
            width: 200px;
        }

        .tile.h2 {
            height: 200px;
        }

        .tile.bgx1 {
            background-position-x: -150px;
        }

        .tile.bgx2 {
            background-position-x: -300px;
        }

        .tile.bgx3 {
            background-position-x: -450px;
        }

        .tile.bgx4 {
            background-position-x: -600px;
        }

        .tile.bgx5 {
            background-position-x: -750px;
        }

        .tile.bgx6 {
            background-position-x: -900px;
        }

        .tile.bgx7 {
            background-position-x: -1050px;
        }

        .tile.bgy1 {
            background-position-y: -157px;
        }

        .tile.bgy2 {
            background-position-y: -314px;
        }

        .tile.bgy3 {
            background-position-y: -471px;
        }

        .tile:hover {
            outline: 5px solid hsla(210, 100%, 50%, 0.7);
            outline-offset: -5px;
            z-index: 2;
        }

        .tile.is-dragging,
        .tile.is-positioning-post-drag {
            outline: none;
            z-index: 2;
            opacity: 0.8;
        }

        .packery-drop-placeholder {
            outline: 3px dashed white;
            outline-offset: -6px;
            transition: transform 0.2s;
        }

        /* -------- */

        .dialog-container {
            width: 600px;
            margin: 0 auto;
            position: relative;
        }

        .dialog {
            position: absolute;
            padding: 20px;
            width: 100%;
            background: #333;
            color: white;
            border-radius: 20px;
            text-align: center;
            font-size: 28px;
            box-shadow: 0 5px 10px hsla(0, 0%, 0%, 0.4);
            z-index: 10;
            transition: opacity 0.2s, transform 0.2s;
        }

        .dialog.is-waiting {
            pointer-events: none;
            opacity: 0;
            transform: translateY(100px);
        }


        .dialog b {
            color: #EA0;
        }
        /*
        .button {
            font-size: 20px;
            background-color: #19F;
            background-image: linear-gradient(hsla(0, 0%, 0%, 0), hsla(0, 0%, 0%, 0.2));
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
        }

        .button:hover {
            cursor: pointer;
            background-color: #3AF;
        }

        .button:active {
            background-color: #C25;
            box-shadow: inset 0 2px 10px hsla(0, 0%, 0%, 0.5);
        }
        */
        .nesw.up,
        .nesw.down {
            /* margin: auto; */
            padding: 0;
        }

        .nesw.right,
        .nesw.left {
            /* margin: auto; */
            max-width: 48px;
            padding: 0;
        }
    </style>

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">

</head>

<body id="body">
    <main id="perfContainer" class="container">

        <div class="dialog-container">
            <div class="dialog is-waiting">
                <p class="dialog__text">&nbsp;</p>
                <div>
                    <button type="button" class="btn btn-secondary try-again-button">Try again</button>
                    <button type="button" class="btn btn-secondary close-dialog-button">Close</button>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-around" style="margin:2rem">
            <h2 class="text-light"><span id="artistsWithVidCount">a</span> Artists x <span id="variationsCount">v</span> Variations = <span id="puzzlesCount">v</span> Puzzles</a></h2>
            <div>
                <button type="button" class="btn btn-primary shuffle-button">Shuffle</button>
            </div>
        </div>
        <div class="d-flex justify-content-center">
                <button type="button" class="btn btn-secondary nesw left text-center align-middle" id="left">&lArr;</button>
            <div class="d-flex flex-column">
                <div class="d-flex flex-column justify-content-center">
                    <button type="button" class="btn btn-secondary nesw up text-center align-middle" id="up">&uArr; </button>
                    <div id="name" class="name text-light" style="margin: auto;"></div>
                </div>
                <div class="grid">
                    <div data-tile="a" class="tile     "></div>
                    <div data-tile="b" class="tile bgx1"></div>
                    <div data-tile="c" class="tile bgx2"></div>
                    <div data-tile="d" class="tile bgx3"></div>
                    <div data-tile="e" class="tile bgx4"></div>
                    <div data-tile="f" class="tile bgx5"></div>
                    <div data-tile="g" class="tile bgx6"></div>
                    <div data-tile="h" class="tile bgx7"></div>
                    <div data-tile="i" class="tile       bgy1"></div>
                    <div data-tile="j" class="tile bgx1  bgy1"></div>
                    <div data-tile="k" class="tile bgx2  bgy1"></div>
                    <div data-tile="l" class="tile bgx3  bgy1"></div>
                    <div data-tile="m" class="tile bgx4  bgy1"></div>
                    <div data-tile="n" class="tile bgx5  bgy1"></div>
                    <div data-tile="o" class="tile bgx6  bgy1"></div>
                    <div data-tile="p" class="tile bgx7  bgy1"></div>
                    <div data-tile="q" class="tile       bgy2"></div>
                    <div data-tile="r" class="tile bgx1  bgy2"></div>
                    <div data-tile="s" class="tile bgx2  bgy2"></div>
                    <div data-tile="t" class="tile bgx3  bgy2"></div>
                    <div data-tile="u" class="tile bgx4  bgy2"></div>
                    <div data-tile="v" class="tile bgx5  bgy2"></div>
                    <div data-tile="w" class="tile bgx6  bgy2"></div>
                    <div data-tile="x" class="tile bgx7  bgy2"></div>
                    <div data-tile="y" class="tile       bgy3"></div>
                    <div data-tile="z" class="tile bgx1  bgy3"></div>
                    <div data-tile="0" class="tile bgx2  bgy3"></div>
                    <div data-tile="1" class="tile bgx3  bgy3"></div>
                    <div data-tile="2" class="tile bgx4  bgy3"></div>
                    <div data-tile="3" class="tile bgx5  bgy3"></div>
                    <div data-tile="4" class="tile bgx6  bgy3"></div>
                    <div data-tile="5" class="tile bgx7  bgy3"></div>
                </div>
                <button type="button" class="btn btn-secondary nesw down text-center align-middle" id="down">&dArr;</button>
            </div>
            <button type="button" class="btn btn-secondary nesw right text-center align-middle" id="right">&rArr;</button>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@latest/moment.min.js"></script>
    <script async type="module">
        import packeryLayout from 'https://cdn.jsdelivr.net/npm/packery@2.1.2/+esm'
        import Draggabilly from 'https://cdn.jsdelivr.net/npm/draggabilly@3.0.0/+esm'
        import { shuffleArray } from "/js/utils.js?v=0.9.4"
        import { loadArtists } from "/js/artists.js?v=0.9.4"

        var grid = document.querySelector('.grid');
        var pckry = new packeryLayout(grid, {
            itemSelector: '.tile',
            columnWidth: 150,
            transitionDuration: '0.3s'
        });

        pckry.getItemElements().forEach(function (itemElem) {
            var draggie = new Draggabilly(itemElem);
            pckry.bindDraggabillyEvents(draggie);
        });

        // map items by their data-tile
        var mappedItems = {};

        pckry.items.forEach(function (item) {
            var attr = item.element.getAttribute('data-tile');
            mappedItems[attr] = item;
        });

        function qwe() {
            console.log('clicked!')
        }

        loadArtists().then((artists) => {

            const artistsWithVid = artists.artists.filter(a => !a.v.still)
            const artistsWithVidCount = artistsWithVid.length
            const variationsCount     = 34
            const puzzlesCount        = 34 * artistsWithVid.length

            document.getElementById('artistsWithVidCount').innerHTML = artistsWithVidCount
            document.getElementById('variationsCount'    ).innerHTML = variationsCount    
            document.getElementById('puzzlesCount'       ).innerHTML = puzzlesCount    

            let v = 0
            let a = 0
            function setName(n) {
                document.getElementById('name').innerHTML = n
            }
            function setImage(n, v) {
                document.querySelectorAll('.tile').forEach(t => {
                    t.style.backgroundImage = `url(/artists/${n}/${n}-${v}.jpg)`
                })
            }
            setName(artistsWithVid[a].fullname)
            setImage(artistsWithVid[a].fullnameNoSpaceLowercaseNoDiacritics, v)

            document.querySelectorAll('#up, #down, #left, #right').forEach(e => e.addEventListener("click", () => {
                console.log(e.id)
                switch (e.id) {
                    case 'up':
                        a = (a + (artistsWithVid.length - 1)) % artistsWithVid.length
                        break;
                    case 'down':
                        a = (a + 1) % artistsWithVid.length
                        break;
                    case 'right':
                        v = (v + 33) % 34
                        break;
                    case 'left':
                        v = (v + 1) % 34
                        break;
                    default:
                        console.log(`Sorry, we are out of ${e.id}.`);
                }
                setName(artistsWithVid[a].fullname)
                setImage(artistsWithVid[a].fullnameNoSpaceLowercaseNoDiacritics, v)
            }))
            function shuffleTiles() {
                // shuffle items
                pckry.items = shuffleArray(pckry.items)
                // stagger transition
                pckry._resetLayout();
                pckry.items.forEach(function (item, i) {
                    setTimeout(function () {
                        pckry.layoutItems([item]);
                    }, i++ * 34);
                });
            }

            var dialog = document.querySelector('.dialog');
            var didWin = false;

            function win() {
                if (!didWin) {
                    document.querySelector('.dialog__text').innerHTML = 'Nice work!<br>';
                }
                didWin = true;
                showDialog();
            }


            function showDialog() {
                dialog.classList.remove('is-waiting');
            }

            function hideDialog() {
                dialog.classList.add('is-waiting');
            }

            dialog.querySelector('.try-again-button').onclick = function () {
                hideDialog();
                shuffleTiles();
            }

            dialog.querySelector('.close-dialog-button').onclick = hideDialog;

            document.querySelector('.shuffle-button').onclick = shuffleTiles;

            pckry.on('dragItemPositioned', function () {
                var order = pckry.items.map(function (item) {
                    return item.element.getAttribute('data-tile');
                }).join('');
                if (pckry.maxY == 628 && order == 'abcdefghijklmnopqrstuvwxyz012345') {
                    win();
                }
            });
        });
    </script>

</body>

</html>