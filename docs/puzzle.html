<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Puzzle</title>

    <!-- bootstrap -->
    <link rel="stylesheet" href="/lib/bootstrap-5.2.3.min.css">
    <style>
        body {
            width: 100vw;
            height: 100vh;
            margin: 4rem 0;
        }

        #thePuzzle {
            width: var(--width);
            height: var(--height);
            margin: auto;
            background-color: white;
        }

        .ligne {
            width: 100%;
            height: calc(var(--height) / var(--yn));
            overflow: visible;
        }

        .colonne {
            width: calc(var(--width) / var(--xn));
            height: calc(var(--height) / var(--yn));
            position: relative;
            background-color: transparent;
            overflow: visible;
        }

        .background {
            position: absolute;
            top: var(--marginY);
            right: var(--marginX);
            bottom: var(--marginY);
            left: var(--marginX);
            background-repeat: no-repeat;
            overflow: visible;
        }

        .background:hover {
            filter: grayscale(1)
        }

        .background.top {
            top: 0;
        }

        .background.right {
            right: 0;
        }

        .background.bottom {
            bottom: 0;
        }

        .background.left {
            left: 0;
        }
    </style>
</head>

<body>
    <div class="container-xxl">
        <div id="thePuzzle" class="d-flex flex-column">

        </div>
    </div>

    <script type="module">
        import packeryLayout from 'https://cdn.jsdelivr.net/npm/packery@2.1.2/+esm'
        import Draggabilly from 'https://cdn.jsdelivr.net/npm/draggabilly@3.0.0/+esm'
        import { shuffleArray, generateElement, normalizeVraiment } from '/js/utils.js'
        import { loadArtists } from "/js/artists.js?v=0.11.1"
        import JigsawShield from '/js/jigsawShield.js?v=0.11.1'

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop)
        })
        let test = params.test ?? undefined
        let coerceArtist = params.a ?? undefined
        let coerceVariation = params.v ?? undefined
        let shuffle = params.shuffle ?? undefined
        if (typeof shuffle !== 'undefined' && (shuffle === 'false' || shuffle === '0' || !shuffle)) {
            shuffle = false
        } else {
            shuffle = true
        }

        const bg = (a, v) => `url('artists/${a}/${a}-${v}.jpg')`

        const _ = {
            xn: 8,
            yn: 4,
            width: 1200,
            height: 630,
        }
        const _manot = {
            xn: 6,
            yn: 6,
            width: 480,
            height: 480,
        }
        _.scale = .99
        _.total = _.xn * _.yn
        const marginX = _.width / (_.xn * 2)
        const marginY = _.height / (_.yn * 2)

        document.documentElement.style.setProperty('--width', `${_.width}px`)
        document.documentElement.style.setProperty('--height', `${_.height}px`)
        document.documentElement.style.setProperty('--xn', `${_.xn}`)
        document.documentElement.style.setProperty('--yn', `${_.yn}`)
        document.documentElement.style.setProperty('--marginX', `${-marginX}px`)
        document.documentElement.style.setProperty('--marginY', `${-marginY}px`)

        const jigsawGenerator = new JigsawShield(_)

        let v = 0
        for (let yi = 0; yi < _.yn; yi++) {
            const row = generateElement(`<div id="row${yi}" class="ligne _${yi} d-flex"></div>`)
            thePuzzle.append(row)
            for (let xi = 0; xi < _.xn; xi++) {

                const vb = jigsawGenerator.getJigsawViewBox(v)
                const topT = yi === 0 ? 0 : marginY
                const leftT = xi === 0 ? 0 : marginX
                const transX = parseInt(vb.replaceAll(/^([\.\d\-]+).*$/g, "$1"))
                const transY = parseInt(vb.replaceAll(/^[\.\d\-]+\s+([\.\d\-]+).*$/g, "$1"))
                const top = yi === 0 ? 'top' : ''
                const right = xi === (_.xn - 1) ? 'right' : ''
                const bottom = yi === (_.yn - 1) ? 'bottom' : ''
                const left = xi === 0 ? 'left' : ''
                const col = generateElement(`
<div id="row${yi}col${xi}" class="colonne draggable" data-index="${v}">
    <svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" viewBox="${jigsawGenerator.getJigsawViewBox(v)}">
        <defs>
            <clipPath id="cp-${v}" >
                <path id="path-${v}" transform="translate(${-transX + leftT} ${-transY + topT})" d="${jigsawGenerator.getJigsawPath(v)}"/> 
            </clipPath>
        </defs>
    </svg>                    
    <div id="_row${yi}col${xi}" class="background ${top} ${right} ${bottom} ${left} " style="clip-path: url(#cp-${v}); transform: scale(${_.scale})">
    </div>
</div>`)
                row.append(col)
                v++
            } // <!--  -->
        }
        let shuffledV = shuffleArray(Array.from(Array(_.xn * _.yn), (_, index) => index + 1))

        loadArtists().then((artists) => {
            const array = coerceArtist ? artists.artists : shuffleArray(artists.artists)
            let i = 0
            array.forEach(a => {
                if (i < _.xn * _.yn) {
                    let xi = i % _.xn
                    let yi = Math.floor(i / _.xn)
                    const id = `_row${yi}col${xi}`
                    const cell = document.getElementById(id)
                    const offsetX = Math.round(normalizeVraiment(xi, 0, _.xn - 1, 0, _.width * (_.xn - 1) / _.xn))
                    const offsetY = Math.round(normalizeVraiment(yi, 0, _.yn - 1, 0, _.height * (_.yn - 1) / _.yn))
                    const borderX = xi === 0 ? 0 : marginX;
                    const borderY = yi === 0 ? 0 : marginY;
                    const artist = coerceArtist ?? a.fullnameNoSpaceLowercaseNoDiacritics
                    const variation = coerceVariation ?? shuffledV[i]

                    cell.style.backgroundImage = `url(/artists/${artist}/${artist}-${variation}.jpg)`
                    // cell.style.backgroundImage = `url(/manot.jpg)`
                    cell.style.backgroundPosition = `-${offsetX - borderX}px -${offsetY - borderY}px`
                }
                i++
            })

            var grid = document.querySelector('#thePuzzle');
            var pckry = new packeryLayout(grid, {
                itemSelector: '.colonne',
            });

            pckry.getItemElements().forEach(function (itemElem) {
                var draggie = new Draggabilly(itemElem);
                pckry.bindDraggabillyEvents(draggie);
            });

            let shuffled = false
            function shuffleTiles() {
                // shuffle items
                if (!shuffled) {
                    pckry.items = shuffleArray(pckry.items)
                    shuffled = true
                } else {
                    pckry.items = pckry.items.sort((a, b) => a.element.getAttribute('data-index') - b.element.getAttribute('data-index'))
                    shuffled = false
                }
                /*
                var order = pckry.items.map(function (item) {
                    return item.element.getAttribute('data-tile');
                }).join('');
                */
                // stagger transition
                pckry._resetLayout();
                pckry.items.forEach(function (item, i) {
                    setTimeout(function () {
                        pckry.layoutItems([item]);
                    }, i++ * 36);
                });
            }

            const handleEsc = (event) => {
                if (event.key === 'Escape') {
                    // if esc key was not pressed in combination with ctrl or alt or shift
                    const isNotCombinedKey = !(event.ctrlKey || event.altKey || event.shiftKey);
                    if (isNotCombinedKey) {
                        shuffleTiles()
                    }
                }
            }
            document.addEventListener('keydown', handleEsc);

        })
    </script>
</body>

</html>